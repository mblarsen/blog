<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Personal blog of Michael B√∏cker-Larsen">

        <meta property="og:title" content="WordPress-style shortcodes using Vue | Blog"/>
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://blog.cheesefi.com/blog/wordpress-style-shortcodes-using-vue"/>
        <meta property="og:description" content="Personal blog of Michael B√∏cker-Larsen" />

        <title>WordPress-style shortcodes using Vue | Blog</title>

        <link rel="home" href="https://blog.cheesefi.com">

        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÄÔ∏è</text></svg>">
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
        <link rel="manifest" href="/site.webmanifest">


        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Blog Atom Feed">

            <meta property="og:title" content="WordPress-style shortcodes using Vue" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://blog.cheesefi.com/blog/wordpress-style-shortcodes-using-vue"/>
    <meta property="og:description" content="" />

                    <!-- Insert analytics code here -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=89b10bbd9bcaf6a81319">
    </head>

    <body class="flex flex-col justify-between min-h-screen font-sans leading-normal text-gray-800 bg-gray-100">
        <header class="flex items-center h-24 py-4 bg-white border-b shadow" role="banner">
            <div class="container flex items-center px-4 mx-auto max-w-8xl lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Blog home" class="inline-flex items-center">
                        <h1 class="my-0 text-lg font-semibold text-blue-800 md:text-2xl hover:text-blue-600">Blog</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex items-center justify-end flex-1">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Blog Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="Blog About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="Blog Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="nav-menu hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Blog Blog"
                href="/blog"
                class="nav-menu__item hover:text-blue-500 "
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog About"
                href="/about"
                class="nav-menu__item hover:text-blue-500 "
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Blog Contact"
                href="/contact"
                class="nav-menu__item hover:text-blue-500 "
            >Contact</a>
        </li>
    </ul>
</nav>

                    <img src="/assets/img/vue-wordpress.png" alt="WordPress-style shortcodes using Vue cover image" class="object-cover min-h-half-screen">
    
        <main role="main" class="container flex-auto w-full max-w-4xl px-6 py-16 mx-auto">
            
    <h1 class="mb-2 leading-none">WordPress-style shortcodes using Vue</h1>

    <p class="text-xl text-gray-700 md:mt-0">Michael B√∏cker-Larsen  ‚Ä¢  March 15, 2017</p>

                        <a
                href="/blog/categories/vue"
                title="View posts in vue"
                class="inline-block px-3 pt-px mr-4 text-xs font-semibold leading-loose tracking-wide text-gray-800 uppercase bg-gray-300 rounded hover:bg-blue-200"
            >vue</a>
                    <a
                href="/blog/categories/howto"
                title="View posts in howto"
                class="inline-block px-3 pt-px mr-4 text-xs font-semibold leading-loose tracking-wide text-gray-800 uppercase bg-gray-300 rounded hover:bg-blue-200"
            >howto</a>
            
    <div class="pb-4 mb-10 border-b border-blue-200" v-pre>
        <p>If you have worked with WordPress as a blogger or developer before, you will undoubtedly know that most sites are built by extensive plugins that spit out <strong>shortcodes</strong>. To me, WordPress has always seemed a bit like a hack. Everything is squeezed into the <code>Post</code> model, whose main body contains more content types and ad hoc data types, depending what content-plugins you've installed. Yikes!</p>

<p>However, this is how it works and the wast number of themes, plugins, and users must be a testament to its success.</p>

<blockquote>
  <p><code>[gallery id="123" size="medium"]</code></p>
</blockquote>

<p>That is a shortcode from the documentation of <a href="https://codex.wordpress.org/Shortcode_API">Wordpress' Shortcode API</a>. Shortcodes are easy to read and understand. Although most of them are generated by a UI tool, anyone could author them by hand. Even as a blogger, you‚Äôd most likely have to every now and then.</p>

<p>The idea of shortcodes is that they provide a super simple content and layout language. When I was asked to help build a project that utilizes shortcodes in a themeable Vue.js application, I was quite excited to see how you could map these shortcodes onto Vue.js components and layout. This concept could provide a tool for site owners to customize the site beyond what was achievable with CSS.</p>

<p>The app we are building has a number of pages. Each of the pages has a few areas that can be customized; some have more customizable areas than others. For example, a checkout page in a web shop would normally have less customization options than the shop‚Äôs front page, where almost all content and layout could be changed in various ways. We call these areas <strong>slots</strong>.</p>

<p>The general idea is to come up with a number of basic components that a theme-developer can style and provide a basic layout for. The application structure remains the same in terms of pages, but the layout and content in each of the slots can vary.</p>

<h2>Goal: Turn shortcodes into Vue components</h2>

<p>Our goal in the building of this app is to be able to add both layout and content components to our shortcode Vue.js integration. For example:</p>

<pre><code class="language-html">&lt;h2&gt;Products&lt;/h2&gt;
[row] [col class="s6"] [product-list name="featured" use="product-card" num=3/]
[/col] [col class="s6"] [product-list name="bestsellers" use="product-card"
num=3/] [/col] [/row]
</code></pre>

<p>In the above example, the row and col(umn) tags represent layout components whereas product-list and product-card will be turned into content components.</p>

<p>Since Vue is all about creating new components and extending the HTML vocabulary, we thought we‚Äôd use our Vue components directly. However, the app we are building excessively targets users in the WordPress community. Therefore, we wanted to try this approach.</p>

<p>Basically these are the steps we need to go through:</p>

<ol>
<li>Convert the string we get from the backend into some other data structure so we can alter the layout and content.</li>
<li>Figure out how we can map the codes to our components, like the ProductList or a ProductCard.</li>
<li>Figure out how to use Vue.js to construct a new component that can instantiate our components.</li>
</ol>

<p>.. and then finally: Demo Time!</p>

<h3>Step 1: Abstract Syntax Tree</h3>

<blockquote>
  <p>Convert the string we get from the backend into some other data structure so we can reason about layout and content.</p>
</blockquote>

<p>This first step is not so interesting. I have built a small library, <a href="https://github.com/mblarsen/shortcode-tokenizer">shortcode-tokenizer</a>, for lexing the sample block above and spitting out an Abstract Syntax Tree (AST).</p>

<p>From the example above, we get an array of nested objects similar to this:</p>

<pre><code class="language-js">[
    {
        type: 'TEXT',
        body: "&lt;h1&gt;Products&lt;/h1&gt;"
        pos: 0
    },
    {
        type: 'OPEN',
        name: 'row',
        pos: 18,
        body: '[row]',
        isClosed: true,
        params: {},
        children: [
            ... a whitespace TEXT token ...,
            {
                type: 'OPEN',
                name: 'col',
                pos: 26,
                body: '[col class="s6"]',
                isClosed: true,
                params: {
                    class: 's6'
                },
                children: [ ... and so on ... ]
             }
        ]
    }
]
</code></pre>

<p>It provides us with a nested object structure that has all parameters prepared and all the elements labeled as text, self-closing, or regular shotcode.</p>

<p>We will use this data structure as the source of what to build in Vue.</p>

<h3>Step 2: Mapping codes to components</h3>

<blockquote>
  <p>Figure out how we map the codes to our components like the <code>ProductList</code> or a <code>ProductCard</code>.</p>
</blockquote>

<p>Vue components are typically named according to the import of the parent component, but Vue is quite flexible and you can reference your components in a number of ways: <code>TitleCase</code>, <code>lowerTitleCase</code>, and <code>kebab-case</code>. The latter is the same syntax we would use for our shortcodes, so this shouldn't be too hard. In most cases, we can just use the same name to refer to the Vue components:</p>

<pre><code class="language-js">export default {
  components: {
    ProductList,
  },
}
</code></pre>

<p><code>ProductList</code> can now, as you know, be referenced as <code>&lt;product-list&gt;</code> in the component template, thanks to a little vue-magic. Vue exposes its name tranformation functions through <code>Vue.util</code>. We will make use of them later.</p>

<p>An argument for making an explicit map: the code name and component name may differ because they follow different guidelines. For example, we have used <code>[col]</code> for a column above, which is a shorthand for a component name. I prefer full words as it reads more easily, but in shortcode land, it's okay to go with the short form‚Ää‚Äî‚Ääit mirrors the <code>[row]</code> code well (things that look alike...).</p>

<p>So although we don‚Äôt actually need to map the code names, this would still be a good idea because it wouldn‚Äôt mess with the way we like to work with Vue.</p>

<p>Another benefit is that we can refer to this map during the parsing. Additionally, in case we come across an unknown code (by absence in the map), we can treat it as an error in the same place as syntax errors‚Äîrather than having to let the errors occur in the Vue runtime when trying to instantiate components that do not exist.</p>

<p>So let us create a map:</p>

<pre><code class="language-js">const codeMap = {
  col: "column",
  row: "row",
  "product-list": "product-list",
}
</code></pre>

<p>The <strong>key</strong> is the shortcode and the <strong>value</strong> is the kebab-cased name of our Vue components.</p>

<h3>Step 3: Wrapping up (or getting started)</h3>

<blockquote>
  <p>Figure out how to use Vue to construct a new component that can instantiate our components.</p>
</blockquote>

<p>Now that we have an AST, we need to parse or render into templates and components using the map we defined in the previous step.</p>

<p>Vue provides a few built-in components that can make your pages more dynamic in the sense that you don‚Äôt have to specify what components are rendered or how they are rendered beforehand. These are <code>&lt;component&gt;</code> and <code>&lt;slot&gt;</code> respectively.</p>

<p>The <code>&lt;component&gt;</code> component‚Äôs functionality is close to what we want. However, we have to include all our components on every page and in every parent component where we want to use or shortcode slot, since the slot, in theory, could contain references to all of our components.</p>

<pre><code class="language-vue">&lt;template&gt;
  &lt;component :is="chosenComponent"&gt;&lt;/component&gt;
&lt;/template&gt;
&lt;script&gt;
import Row from "components/Row"
import Column from "components/Column"
import ProductList from "components/ProductList"
import ProductCard from "components/ProductCard"
// ... and so on ...

export default {
  components: {
    Row,
    Column,
    ProductList,
    ProductCard,
    // ... and so on  ...
  },
  data() {
    return { chosenComponent: "product-list" }
  },
}
&lt;/script&gt;
</code></pre>

<p>This a bit cumbersome to say the least. We don‚Äôt want to repeat this for each parent component. This chore needs to be encapsulated as well.</p>

<h3>Requirements</h3>

<p>So let's wrap this up. We will make a new component that is similar to <code>&lt;component&gt;</code>, but one that has knowledge of all the components that we want to expose to the shortcode slot. We will call this <code>&lt;code-slot&gt;</code>.</p>

<p>But first, recall our template is a mixture of text (HTML) and shortcodes. Basically, we can have text all around and between each of the open and close codes. We need to add this to the template as well.</p>

<p>When you have highly dynamic content, <code>&lt;component&gt;</code> and <code>&lt;slot&gt;</code> might not be enough. In that case, you can write your own render function.</p>

<p>(Internally, all your templates are turned into render functions.)</p>

<p>Our component acts as a controller in terms of what gets rendered but doesn‚Äôt add any value content or functionality besides the content of the slot. For these kinds of scenarios, you would go for a <a href="https://vuejs.org/v2/guide/render-function.html#Functional-Components">functional component</a>, because it has less overhead as it does not maintain state. You would simply pass on control to another component. However, since we also have to render the text, we don‚Äôt have a single component that can handle all our needs. For this reason, we will use a regular component.</p>

<p>(If anyone knows if and how the following can be made as a functional component, I would love to learn how!)</p>

<p>Here goes. We will need Vue and the tokenizer:</p>

<pre><code class="language-vue">// components/CodeSlot.vue import { default as Tokenizer } from
'shortcode-tokenizer' import Vue from 'vue'
</code></pre>

<p>We also want to import all the components we want to include as shortcodes:</p>

<pre><code class="language-js">import Row from "components/Row"
import Column from "components/Column"
import ProductList from "components/ProductList"
import ProductCard from "components/ProductCard"
</code></pre>

<p>Then we add our map, but with a little twist. We need the map in two cases.</p>

<ol>
<li>to get the kebab-cased name for building the template</li>
<li>to pass into the <code>components:</code> property of our component, so instead of mapping from code to component name, we will map directly to the imported component:</li>
</ol>

<pre><code class="language-js">const codeMap = {
  row: Row,
  column: Column,
  col: Column,
  "product-list": ProductList,
  "product-card": ProductCard,
}

const allComponents = Object.values(codeMap).reduce((all, c) =&gt; {
  all[Vue.util.hyphenate(c.name)] = c
  return all
}, {})
</code></pre>

<p>Note that we have both <code>col</code> and <code>column</code> in <code>codeMap</code> ‚Äî this means that both can be used as shortcodes. However, Vue will complain if you try to use <code>col</code> because this is already an HTML tag. Instead of using the code map directly, we'll map it to a new object where the key is based on a hyphenated (kebab) version of the component‚Äôs name.</p>

<p>(Note: if you are using Webpack or something similar, you‚Äôll need to add a <code>name:</code> property to your components. Otherwise, the name will be an odd internal Webpack value.)</p>

<h3>The Component</h3>

<p>So let's start to flesh out the actual component:</p>

<pre><code class="language-js">export default {
    props: {
        content: {
            type: String,
            required: true
        },
        strict: {
            type: Boolean,
            default: true
        }
    },
    methods: {
        renderContent() {
            // Turn AST into template and handle syntax error
        }
    },
    created: {
        this.tokenizer = new Tokenizer()
    },
    render(h) {
        return h(Vue.component('code-wrapper', {
            template: this.renderContent(),
            components: allComponents
        }))
    }
}
</code></pre>

<p>The idea behind this approach is to programmatically create yet another component ‚Äî <code>&lt;code-wrapper&gt;</code> ‚Äî as a child of our <code>&lt;code-slot&gt;</code> component. In our template code of a parent component, we include the code slot:</p>

<pre><code class="language-html">&lt;aside&gt;
  &lt;code-slot :content="sidebarContent"&gt;&lt;/code-slot&gt;
&lt;/aside&gt;
</code></pre>

<p>So say that we put a product list in the sidebar slot:</p>

<pre><code class="language-html">&lt;h3&gt;Featured&lt;/h3&gt;
[product-list name="featured" num=3 use="product-card"/]
</code></pre>

<p>Then our Vue hierarchy will end up looking like this:</p>

<p><img src="/assets/img/vue-wordpress-inspector.png" alt="Vue hierarchy from the Chrome developer tool" />
(CodeSlot is our controlling component that creates CodeWrapper which is a template that contains both HTML and our custom component ProductList)</p>

<h3>Rendering</h3>

<p>I will not cover the entire rendering process but you can look into it more in <a href="https://gist.github.com/mblarsen/f628fc3c196b5f58d326242061922446">this gist</a> which includes the component in its entirety.</p>

<p>The body of this function can be kept pretty simply. An important part is how we handle syntax errors to prevent our Vue application from running astray.</p>

<pre><code class="language-js">export default {
    ...
    methods: {
      renderContent() {
        try {
          let ast = this.tokenizer
            .input(this.content)
            .ast()
          let content = ast
            .map(renderToken)
            .join('')
          return ensureOneRoot(ast, content)
        } catch (err) {
          console.error(err)
          return `&lt;div class="error"&gt;${err.message}&lt;/div&gt;`
        }
      }
    }
    ...
}
</code></pre>

<p>Our content prop value (from our parent) is passed into the tokenizer, which returns an AST, an array of root tokens. We pass each token into render function (not shown here), which returns a part of our final template that we then join with all the other parts. Lastly, before returning, we ensure that the generated template only has one root‚Ää‚Äî‚Ääa requirement of Vue components.</p>

<p>In the rendering process, I‚Äôm simply passing the tokens through a series of transformer functions recursively. As an example, this is the render function for codes that has an open and a close part:</p>

<pre><code class="language-js">function renderOpen(token) {
  if (token.type === Tokenizer.OPEN) {
    let name = getComponentName(token)
    let params = renderParams(token)
    let children = token.children.map(renderToken).join("")
    token.output = `&lt;${name}${params}&gt;${children}&lt;/${name}&gt;`
  }
  return token
}
</code></pre>

<p>You don‚Äôt have to mirror AST exactly. You can skip nodes, add new ones, or as in this example, the <code>keep-alive</code> parameter is converted into a wrapper of the component:</p>

<pre><code class="language-js">// example input: [product-list keep-alive/]
function wrapKeepAlive(token) {
  if (typeof token.params["keep-alive"] !== "undefined") {
    token.output = `&lt;keep-alive&gt;${token.output}&lt;/keep-alive&gt;`
  }
  return token
}
</code></pre>

<h3>Error Handling</h3>

<p>You should naturally validate your codes in all the authored content before publishing, but we will handle it here nonetheless. Besides, this component can also be used in the CMS, and the <a href="https://github.com/mblarsen/shortcode-tokenizer">shortcode-tokenizer</a> can be used in the backend if you run Node.js.</p>

<p>For this demo, the handling is no more than outputting the error with a token and outputting it to the console.</p>

<h2>Demo time</h2>

<p>Our next step will be to figure out how well this works with theming. For now, let‚Äôs see what we have achieved.</p>

<p>Questions and feedback are most welcome. I‚Äôm still relatively new to Vue.js myself. If you‚Äôve just started learning Vue.js, make sure to check out <a href="https://www.codementor.io/javascript/tutorial/getting-started-with-vuejs">Getting Started with Vue.js: Why Use it?</a></p>

<p><img src="/assets/img/vue-wordpress-demo.gif" alt="demo-time.gif" />
(Note how syntax errors are shown whenever the the codes are incomplete. <code>ProductCard</code> and <code>ProductListItem</code> are two different components that the <code>ProductList</code> component can use to render a product. <code>Row</code> and <code>Column</code> are simple wrappers around a CSS grid framework.)</p>

<p>References:</p>

<ul>
<li><a href="https://gist.github.com/mblarsen/f628fc3c196b5f58d326242061922446">CodeSlot.vue</a></li>
<li><a href="https://github.com/mblarsen/shortcode-tokenizer">shortcode-tokenizer</a></li>
<li><a href="https://vuejs.org/v2/guide/render-function.html#Functional-Components">Functional Components in Vue</a></li>
</ul>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                    </div>

        <div>
                            <a href="https://blog.cheesefi.com/blog/vue-user-permissions-through-directives" title="Newer Post: Vue user-permissions through directives">
                    Vue user-permissions through directives &RightArrow;
                </a>
                    </div>
    </nav>

    <div class="my-8">
        <script src="https://utteranc.es/client.js"
                repo="mblarsen/blog"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
    </div>
        </main>

        <footer class="py-4 mt-12 text-sm text-center bg-white" role="contentinfo">
            <ul class="flex flex-col justify-center list-none md:flex-row">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2020.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=6fcce2a82cb71a0ef04a"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
